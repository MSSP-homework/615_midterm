---
title: "615 Midterm"
author: "Amie Thomas"
date: "2023-10-30"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

install.packages("sf")
install.packages("leaflet")
install.packages("maps")
library(readr)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(viridis)
library(maps)
library(sf)
#library(leaflet)
```

-How dangerous are floods? 
-How expensive? 
-Is there any pattern to the kinds of communities that suffer losses from floods?

###<NOAA>###


#load in the NOAA data and merge
```{r}
Mydata <- read_csv("StormEvents_details-ftp_v1.0_d2020_c20230927.csv.gz")
Mydata_2 <- read_csv("StormEvents_details-ftp_v1.0_d2021_c20231017.csv.gz")
noaa_20_21 <- rbind(Mydata, Mydata_2)
#how much damage was done
```

#get rid of columns not of interest
```{r}
noaa_20_21 <- noaa_20_21 |>
  filter(EVENT_TYPE == "Flood") |>
   select(-MAGNITUDE, -MAGNITUDE_TYPE, -CATEGORY, -TOR_F_SCALE, -TOR_LENGTH, -TOR_WIDTH, 
          -TOR_OTHER_WFO, -TOR_OTHER_CZ_STATE, -TOR_OTHER_CZ_FIPS, -TOR_OTHER_CZ_NAME,
          -BEGIN_RANGE,-BEGIN_AZIMUTH, -END_RANGE, -END_AZIMUTH, -CZ_TIMEZONE, -DATA_SOURCE,
          -WFO)
```

#change damage data into useable intergers
```{r}
noaa_20_21$DAMAGE_PROPERTY <- str_replace_all(noaa_20_21$DAMAGE_PROPERTY, "[^0-9.]", "")
noaa_20_21$DAMAGE_PROPERTY <- as.numeric(noaa_20_21$DAMAGE_PROPERTY)
noaa_20_21$DAMAGE_PROPERTY <- round(noaa_20_21$DAMAGE_PROPERTY)
options(scipen = 999)
noaa_20_21$DAMAGE_PROPERTY <- noaa_20_21$DAMAGE_PROPERTY*100000


noaa_20_21$DAMAGE_CROPS <- str_replace_all(noaa_20_21$DAMAGE_CROPS, "[^0-9.]", "")
noaa_20_21$DAMAGE_CROPS <- as.numeric(noaa_20_21$DAMAGE_CROPS)
noaa_20_21$DAMAGE_CROPS <- round(noaa_20_21$DAMAGE_CROPS)
options(scipen = 999)
noaa_20_21$DAMAGE_CROPS <- noaa_20_21$DAMAGE_CROPS*100000

```

#filter out events with no damage
```{r}
noaa_20_21 <- noaa_20_21 %>%
  filter(DAMAGE_PROPERTY != 0 | DAMAGE_CROPS != 0)

noaa_20_21 <- noaa_20_21 |>
  mutate(DAMAGE_TOTAL = DAMAGE_CROPS + DAMAGE_PROPERTY)|> #create total damage column
  relocate(DAMAGE_TOTAL, .before = SOURCE)

options(scipen = 999) #out of sci. notation
```


#NOAA Questions
-what types of flood causes result in the most damage
```{r}

cause_dam <- noaa_20_21 |>
  mutate(Year = as.numeric(substr(BEGIN_YEARMONTH, 1, 4)),  
         Month = as.numeric(substr(BEGIN_YEARMONTH, 5, 6))) |> 
  group_by(FLOOD_CAUSE, Year, Month) |> 
  summarise(DAMAGE_TOTAL = sum(DAMAGE_TOTAL))


ggplot(cause_dam, aes(x = Month, y = DAMAGE_TOTAL, color = FLOOD_CAUSE)) +
  geom_line(size = 1) +
  scale_x_continuous(breaks = 1:12, labels = month.abb) +
  scale_y_continuous(labels = scales::comma, breaks = seq(0, 600000000, by = 100000000)) +
  labs(title = "Damage by Flood Cause",
       subtitle = "for years 2020-2021",
       x = "Month", 
       y = "Total Damage", 
       color = "Flood Cause") +
  theme_minimal()



```

#
-what months have the most floods
```{r}
flood_month <- noaa_20_21 |>
  group_by(MONTH_NAME) |>
  summarise(count = n()) |>
  arrange(desc(count))

custom_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December")


flood_month$MONTH_NAME <- factor(flood_month$MONTH_NAME, levels = custom_order)


ggplot(flood_month, aes(x = MONTH_NAME, y = count, fill = MONTH_NAME)) +
  geom_bar(stat = "identity") +
  labs(x = "Month", y = "Count of Floods") +
  ggtitle("Flood Count by Month") +
  labs(subtitle = "Years 2020-2021")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

  
```
#This graph shows that most floods for the years 2020-2021 occurred during the month of Februray


-states with the most flood damage ##trying visualize as a map but it will not work ugggghhh
```{r}
state_dam <- noaa_20_21 |>
  group_by(STATE) |>
  summarise(DAMAGE_TOTAL = sum(DAMAGE_TOTAL)) |>
  arrange(desc(DAMAGE_TOTAL))

#load a dataset that contains the geographical coordinates of the boundaries of U.S. states.
states_map <- map_data("state")

#change to lowercase for matching
state_dam$STATE <- str_to_lower(state_dam$STATE)

#merge original with spatial 
dam_map <- left_join(states_map, state_dam, by = c("region" = "STATE"))|>
  select(-subregion)

dam_map <- dam_map |>
  distinct(DAMAGE_TOTAL, .keep_all = TRUE)

ggplot(dam_map, aes(x = long, y = lat, group = group, fill = DAMAGE_TOTAL)) +
geom_polygon(colour = "black") +
coord_map("polyconic")




```


-what states have what types of flood causes
```{r}

state_trop <- noaa_20_21 |>
  filter(FLOOD_CAUSE == "Heavy Rain / Tropical System") |>
  group_by(STATE)
#Florida

state_ice <- noaa_20_21 |>
  filter(FLOOD_CAUSE == "Ice Jam")|>
  group_by(STATE)

state_burn <- noaa_20_21 |>
  filter(FLOOD_CAUSE == "Heavy Rain / Burn Area")|>
  group_by(STATE)

state_melt <- noaa_20_21 |>
  filter(FLOOD_CAUSE == "Heavy Rain / Snow Melt")|>
  group_by(STATE)

state_levee <- noaa_20_21 |>
  filter(FLOOD_CAUSE == "Dam / Levee Break")|>
  group_by(STATE)

state_release <- noaa_20_21 |>
  filter(FLOOD_CAUSE == "Planned Dam Release")|>
  group_by(STATE)

state_just_rain <- noaa_20_21 |>
  filter(FLOOD_CAUSE == "Heavy Rain")|>
  group_by(STATE)
```













###<FEMA>###

#load in the FEMA data and merge
```{r}
Mydata_3 <- read_csv("FemaWebDisasterSummaries.csv")
Mydata_4 <- read_csv("DisasterDeclarationsSummaries.csv")
fema_data <- left_join(Mydata_3, Mydata_4, "disasterNumber")
#how much relief was sent
```

#filter to keep only columns of interest
```{r}
fema_data$incidentBeginDate <- year(fema_data$incidentBeginDate)
fema_data_int <- fema_data |> 
  filter(incidentType == "Flood") |>
  filter(incidentBeginDate == "2020" | incidentBeginDate ==  "2021")|>
  select(-hash.x, -lastRefresh.x, -id.x, -declarationType, -disasterCloseoutDate, 
         -tribalRequest, -lastRefresh.y, -id.y, -hash.y, -iaLoadDate, -lastIAFilingDate, -ihProgramDeclared, -iaProgramDeclared, -paProgramDeclared, -hmProgramDeclared)|>
  relocate(designatedArea, .before = declarationDate)

#take care of NA's
fema_data_int$totalNumberIaApporved[is.na(fema_data_int$totalNumberIaApproved)] <- 0
fema_data_int$totalAmountIhpApproved[is.na(fema_data_int$totalAmountIhpApproved)] <- 0
fema_data_int$totalAmountHaApproved[is.na(fema_data_int$totalAmountHaApproved)] <- 0
fema_data_int$totalAmountOnaAproved[is.na(fema_data_int$totalAmountOnaAproved)] <- 0

#need to figure out what these mean and what is the actually amount sent as relief to help people in these areas
```

#FEMA Questions
-what counties receive the most relief
-further what are the demographics in this area 
-how long did it take for this area to receive support

#Need to know 
-totalnumberIaapproved
-totalamountihpapproved
-totalamounthaapproved
-totalamountOnaapproved
-so many different variables what the hell is the one that tells me the information i want to know
